<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雨天信箱 - The Raindrop Box</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📮</text></svg>">
</head>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<body class="sunny-mode">
    <div id="weather-background"></div>
    
    <div class="container glass-effect fade-in">
        <header>
            <h1>📮 雨天信箱</h1>
            <p>The Raindrop Box</p>
            <div class="status-indicator status-sunny" id="current-weather">🌤️ 晴天模式</div>
        </header>
            <!-- 新增：天气元信息显示区 -->
        <div id="weather-meta" style="text-align: center; margin: 11px 0; font-size: 15px; color: #555;">
        📍 <span id="weather-location">加载中...</span> | 
        🌦️ <span id="weather-text">--</span> |
        🕒 <span id="next-refresh">--</span> 秒后刷新
        </div>

        <!-- 晴天界面 -->
        <div id="sunny-interface">
            <div class="message-form">
                <h2>✉️ 写下你的想法</h2>
                <div class="form-group">
                    <label for="message-input">你的想法（最多500字）</label>
                    <textarea id="message-input" placeholder="在这里写下你想说的话..." maxlength="500"></textarea>
                    <div class="char-counter">已输入 <span class="char-count">0</span>/500 字</div>
                    {% if turnstile_site_key %}
                        <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}"></div>
                    {% endif %}
                </div>
                <button id="submit-btn" class="primary-btn">投递想法</button>
            </div>
            
            <div class="weather-info">
                <p>🌤️ 当前天气晴朗，信箱封存中</p>
                <p>🌧️ 等到下雨时，所有想法将会公开</p>
            </div>
        </div>

        <!-- 雨天界面 -->
        <div id="rainy-interface" style="display: none;">
            <div class="message-form">
                <h2>🌧️ 雨中分享</h2>
                <div class="form-group">
                    <label for="rainy-message-input">你的想法（最多500字）</label>
                    <textarea id="rainy-message-input" placeholder="雨声中写下你的心声..." maxlength="500"></textarea>
                    <div class="char-counter">已输入 <span class="char-count">0</span>/500 字</div>
                    {% if turnstile_site_key %}
                        <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}"></div>
                    {% endif %}
                </div>
                <button id="rainy-submit-btn" class="primary-btn">投递想法</button>
            </div>

            <div class="messages-list">
                <h2>📜 公开的想法</h2>
                <div id="messages-container">
                    <div class="loading">加载中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 成功模态框 -->
    <div id="success-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div id="share-card" class="share-card">
                <h3>📨 存票凭证</h3>
                <p>第 <span id="card-message-id">0</span> 号寄信人</p>
                <p>存入时间: <span id="card-created-at">-</span></p>
                <p>服务器状态: <span id="card-weather-status">-</span></p>
                <p>总消息数: <span id="card-total-messages">0</span></p>
                <div id="qr-code-container"></div>
                <p class="qr-url">https://dropbox.techccy.dpdns.org</p>
            </div>
            
            <div class="modal-actions">
                <button id="save-card-btn" class="primary-btn">保存存票</button>
                <button id="close-modal-btn" class="secondary-btn">关闭</button>
            </div>
        </div>
    </div>

    <!-- 脚本引用 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
<script>
// 等待页面加载完成
document.addEventListener('DOMContentLoaded', function() {
    const locationElem = document.getElementById('weather-location');
    const textElem = document.getElementById('weather-text');
    const refreshElem = document.getElementById('next-refresh');

    // 如果元素存在，才执行
    if (locationElem && textElem && refreshElem) {
        fetchWeatherMeta();
        setInterval(fetchWeatherMeta, 1000); // 每秒更新倒计时
    }
});

let lastRefreshTime = null;

function fetchWeatherMeta() {
    fetch('/api/weather/meta')
        .then(response => response.json())
        .then(data => {
            // 更新 DOM
            document.getElementById('weather-location').textContent = data.location;
            document.getElementById('weather-text').textContent = data.weather_text;
            document.getElementById('next-refresh').textContent = data.next_refresh_in_seconds;

            // 记录上次成功获取时间（用于调试）
            lastRefreshTime = new Date();
        })
        .catch(err => {
            console.error('Failed to fetch weather meta:', err);
        });
}
</script>